---
title: "Replication of Shepherd/You 2020"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{shepherd_you_replication}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(simloglm)
```

```{r Useful functions}
# Clustered Standard Errors
# Function according to Arai:

clx <- function(fm, dfcw, cluster) {
  require(sandwich)
  require(lmtest)
  require(zoo)
  
  M <- length(unique(cluster)) # Number of Clusters
  N <- length(cluster) # Number of Observations
  
  dfc <-
    (M / (M - 1)) * ((N - 1) / (N - fm$rank)) # Adjust degrees of freedom
  
  u <- apply(estfun(fm), 2, function(x)
    tapply(x, cluster, sum))
  
  vcovCL <- dfc * sandwich (fm, meat = crossprod(u) / N) * dfcw
  
  print(coeftest(fm, vcovCL)) # Print Results to console
  
  return(vcovCL) # Return Variance-Covariance Matrix
}
```


```{r Preprocessing}
df <- simloglm::shepherd_you_2020

df$ln_meansalary <- log(df$meansalary + 1)
df$nolobstaff <- df$numstaff - df$futurelob

df$femaleratio <- df$numfemale / df$numstaff


df$lnles <- log(df$les + 1)
df$lntotbill <- log(df$totbill + 1)
df$lnssbill <- log(df$ss_bills + 1)

```

```{r Model}
# Define the Model Formulas

member_char1 <-
  c(
    "majority dwnom1 budget chair subchr seniority maj_leader min_leader power dem membecamelob female afam latino state_leg south_dem"
  )
member_char1 <- gsub(" ", " + ", member_char1)

member_char2 <-
  c("majority dwnom1 budget chair subchr seniority maj_leader min_leader power")
member_char2 <- gsub(" ", " + ", member_char2)

staff_char1 <-
  c("ln_meansalary nolobstaff futurelob cstaff_lob femaleratio")
staff_char1 <- gsub(" ", " + ", staff_char1)

ff <-
  paste0("lnles ~ ",
         staff_char1,
         " + ",
         member_char2,
         " + congress + icpsr")

df$congress <- as.factor(df$congress)
df$icpsr <- as.factor(df$icpsr)
# Run Model 4

m4 <- lm(ff, data = df)

vcovCL <-
  clx(m4, 1, m4$model$'icpsr') # Clustered Variance-Covariance Matrix

```

```{r}
# Residualize Treatment for interpretation according to

est <- m4$model

colnames(est)[16:17] <- c("congress", "icpsr")

## make an object that is the variable name of the treatment

x <- "futurelob"

## store the coefficient estimate

b <- m4$coefficients[x]
x.resid <-
  lm(
    futurelob ~ ln_meansalary + nolobstaff  + cstaff_lob + femaleratio + majority + dwnom1 + budget + chair + subchr + seniority + maj_leader + min_leader + power +congress + icpsr,
    data = est
  )$residuals

reg2 <- lm(est$lnles ~ x.resid)


y.resid <-
  lm(
    lnles ~ ln_meansalary + nolobstaff  + cstaff_lob + femaleratio + majority + dwnom1 + budget + chair + subchr + seniority + maj_leader + min_leader + power + congress + icpsr,
    data = est
  )$residuals

reg3 <- lm(y.resid ~ x.resid)

# Range of original treatment variable (futurelob)
range(est[, x])

# SD of original treatment variable (futurelob)
(sdx <- sd(est[, x]))

# SD of residualized Treatment
(sdxresid <- sd(x.resid))
round(sdxresid, 2)
```

```{r}

# Set scenario for simulation

# Extract Model Frame
mf <- model.frame(ff, m4$model)

# Transform to Model Frame to Design Matrix
mm <- model.matrix(as.formula(ff), mf)

# Average Case Approach, Baseline all set to its mean
scenario <- apply(mm, 2, mean)

# Average Case Approach, 1 SD increase in futurelob
scenario_sd <- scenario
scenario_sd["futurelob"] <- scenario_sd["futurelob"] + sdxresid

# Combine the two scenarios in one matrix
scenario <- rbind(scenario, scenario_sd)

results_aca <- simloglm(m4, X = scenario,  observed_value_approach = F, fast = T)

results_ova <- simloglm(m4, scenario = list(futurelob = c(mean(m4$model$futurelob),mean(m4$model$futurelob)+sdxresid)),  observed_value_approach = T, fast = T)
```



```{r Plot, fig.width=5* (1 + sqrt(5)) / 2, fig.height=5, fig.path="shepherd_you_figures/", dev = "pdf", warning=FALSE}
# Summarize results

# First Difference as difference between expected values on the original scale
fd_aca_dist <-
  results_aca$geometric_mean[, 2] - results_aca$geometric_mean[, 1]
fd_aca <-
  exp(mean(log(results_aca$geometric_mean[, 2]))) - exp(mean(log(results_aca$geometric_mean[, 1])))


# Ratio instead of fd
# The minus 1 offset matters here (doesn't for the fd above)
percent_increase_aca_dist <-
  ((results_aca$geometric_mean[, 2] - 1) / (results_aca$geometric_mean[, 1] - 1)) -
  1
percent_increase_aca <-
  ((exp(mean(
    log(results_aca$geometric_mean[, 2])
  )) - 1) / (exp(mean(
    log(results_aca$geometric_mean[, 1])
  )) - 1)) - 1

old_par <- par()
par(old_par)

par(
  lend = 1,
  las = 1,
  mfrow = c(2, 1)
)

plot(
  1,
  1,
  ylim = c(0, 2),
  pch = "|",
  col = adjustcolor(viridis::viridis(2)[1], 0.2),
  type = "n",
  bty = "n",
  ylab = "",
  yaxt = "n",
  xaxt = "n",
  xlab = "",
  xlim = pretty(c(min(fd_aca_dist), max(fd_aca_dist)))[c(1, length(pretty(c(
    min(fd_aca_dist), max(fd_aca_dist)
  ))))]
)
title("",
      xlab = "Difference in Legislative Effectiveness Scores (LES)",
      ylab = "",
      col.lab = "grey")

axis(
  1,
  at = c(min(fd_aca_dist), max(fd_aca_dist)),
  labels = round(c(min(fd_aca_dist), max(fd_aca_dist)), 2),
  lwd = 0,
  lwd.ticks = 1,
  col = "grey",
  col.axis = "grey"
)
axis(
  1,
  at = pretty(c(min(fd_aca_dist), max(fd_aca_dist)))[c(2:(length(pretty(c(
    min(fd_aca_dist), max(fd_aca_dist)
  ))) - 1))],
  lwd = 0.5,
  lwd.ticks = 1,
  col = "grey",
  col.axis = "grey"
)
axis(
  2,
  at = 1,
  labels = "(A)",
  lwd = 1,
  lwd.ticks = 0,
  col = "grey",
  col.axis = "grey"
)
segments(
  x0 = quantile(fd_aca_dist, 0.1),
  y0 = 1,
  x1 = quantile(fd_aca_dist, 0.9),
  col = adjustcolor(viridis::viridis(2)[1], 1),
  lwd = 8,
  lend = 1
)
segments(
  x0 = quantile(fd_aca_dist, 0.025),
  y0 = 1,
  x1 = quantile(fd_aca_dist, 0.975),
  col = adjustcolor(viridis::viridis(2)[1], 1),
  lwd = 4,
  lend = 1
)
segments(
  x0 = quantile(fd_aca_dist, 0.005),
  y0 = 1,
  x1 = quantile(fd_aca_dist, 0.995),
  col = adjustcolor(viridis::viridis(2)[1], 1),
  lwd = 2,
  lend = 1
)
points(mean(fd_aca_dist),
       1,
       pch = 1,
       col = viridis::viridis(2)[2])
points(fd_aca, 1, pch = 124, col = viridis::viridis(2)[2])
legend(
  "top",
  legend = c("GM", "mean", "80% CI", "95% CI", "99% CI"),
  pch = c(124, 1, NA, NA, NA),
  lty = c(NA, NA, "solid", "solid", "solid"),
  lwd = c(NA, NA, 8, 4, 2),
  col = c(
    viridis::viridis(2)[2],
    viridis::viridis(2)[2],
    viridis::viridis(2)[1],
    viridis::viridis(2)[1],
    viridis::viridis(2)[1]
  ),
  bty = "n",
  ncol = 5,
  text.col = "grey"
)

fd <- percent_increase_aca_dist
plot(
  1,
  1,
  ylim = c(0, 2),
  pch = "|",
  col = adjustcolor(viridis::viridis(2)[1], 0.2),
  type = "n",
  bty = "n",
  ylab = "",
  yaxt = "n",
  xaxt = "n",
  xlab = "",
  xlim = pretty(c(min(fd), max(fd)))[c(1, length(pretty(c(min(
    fd
  ), max(
    fd
  )))))]
)
title("",
      xlab = "% Change Legislative Effectiveness Scores (LES)",
      ylab = "",
      col.lab = "grey")

axis(
  1,
  at = c(min(fd), max(fd)),
  labels = round(c(min(fd), max(fd)), 2) * 100,
  lwd = 0,
  lwd.ticks = 1,
  col = "grey",
  col.axis = "grey"
)
axis(
  1,
  at = pretty(c(min(fd), max(fd)))[c(2:(length(pretty(c(
    min(fd), max(fd)
  ))) - 1))],
  labels = pretty(c(min(fd), max(fd)))[c(2:(length(pretty(c(
    min(fd), max(fd)
  ))) - 1))] * 100,
  lwd = 0.5,
  lwd.ticks = 1,
  col = "grey",
  col.axis = "grey"
)
axis(
  2,
  at = 1,
  labels = "(B)",
  lwd = 1,
  lwd.ticks = 0,
  col = "grey",
  col.axis = "grey"
)
segments(
  x0 = quantile(fd, 0.1),
  y0 = 1,
  x1 = quantile(fd, 0.9),
  col = adjustcolor(viridis::viridis(2)[1], 1),
  lwd = 8,
  lend = 1
)
segments(
  x0 = quantile(fd, 0.025),
  y0 = 1,
  x1 = quantile(fd, 0.975),
  col = adjustcolor(viridis::viridis(2)[1], 1),
  lwd = 4,
  lend = 1
)
segments(
  x0 = quantile(fd, 0.005),
  y0 = 1,
  x1 = quantile(fd, 0.995),
  col = adjustcolor(viridis::viridis(2)[1], 1),
  lwd = 2,
  lend = 1
)
points(mean(fd), 1, pch = 1, col = viridis::viridis(2)[2])
points(percent_increase_aca, 1, pch = 124, col = viridis::viridis(2)[2])


```

